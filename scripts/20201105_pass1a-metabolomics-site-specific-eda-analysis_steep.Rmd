---
title: | 
 | PASS1A (Rat) Metabolomics: 
 | Site-Specific Comparisons (Triple)
author: "Alec Steep"
date: "11/05/2020"
#always_allow_html: true
output:
     html_document:
         code_folding: hide
         toc: true
         highlight: zenburn
         css: ../css/style.css
---

## Setup the Environment
```{r Setup the Environment, message=FALSE, results='hide', warning = FALSE, echo = FALSE}
################################################################################
##### Resources and Dependencies ###############################################
################################################################################

# Set the working directory
#############################################################################
COMP <- "MacBook" 
#COMP <- "GreatLakes"       
if(COMP == "MacBook"){
        # MacBook
        WD <- '/Volumes/Frishman_4TB/motrpac/20200915_metabolomics-pass1a'    
}else if(COMP == "GreatLakes"){
        # MichMed
        WD <- '/home/acsteep/motrpac/20200915_metabolomics-pass1a'
}

#setwd(WD)

# Load the dependencies
#source("https://bioconductor.org/biocLite.R")
#BiocManager::install("org.Rn.eg.db")
#install.packages("kableExtra")

# Load dependencies
pacs...man <- c("tidyverse", "data.table","rlang","RColorBrewer","MASS","sfsmisc",
                "pheatmap","caret","ggforce","RANN","kableExtra","gtools","combinat",
                "knitr","markdown","rmarkdown","gridExtra","cowplot","devtools")
for(pac in pacs...man){
  suppressWarnings(suppressPackageStartupMessages(library(pac, character.only = TRUE)))
}
# lapply(pacs...man, FUN = function(X) {
#         do.call("library", list(X)) })

############################################################
##### Functions ############################################
############################################################

# Name functions
select <- dplyr::select
counts <- DESeq2::counts
map <- purrr::map
desc <- dplyr::desc
arrange <- dplyr::arrange
melt <- reshape2::melt
mutate <- dplyr::mutate

# Global options
options(dplyr.print_max = 100)
options(scipen=10000)

# Source the functions
source(paste0(WD,'/functions/not_in.R'))
source(paste0(WD,'/functions/rat_mouse_ortho.R'))
source(paste0(WD,'/functions/mouse2rat_ortho.R'))
source(paste0(WD,'/functions/lmp.R'))
source(paste0(WD,'/functions/cor_PC_1_6.R'))
source(paste0(WD,'/functions/elbow_finder.R'))
source(paste0(WD,'/functions/cor_outlier2.R'))
source(paste0(WD,'/functions/DissimilarityMatrixNominal.R'))
source(paste0(WD,'/functions/lm_eqn.R'))
source(paste0(WD,'/functions/reorder_cormat.R'))
source(paste0(WD,'/functions/save_pheatmap_pdf.R'))
source(paste0(WD,'/functions/modeav.R'))
source(paste0(WD,'/functions/count_na.R'))
source(paste0(WD,'/functions/se_mean.R'))
source(paste0(WD,'/functions/Mode.R'))
source(paste0(WD,'/functions/NumericSummaryStats.R'))
source(paste0(WD,'/functions/AutoScaleMatrix.R'))
source(paste0(WD,'/functions/ReverseAutoScaleMatrix.R'))
source(paste0(WD,'/functions/CenterMatrix.R'))
source(paste0(WD,'/functions/RangeScaleMatrix.R'))
source(paste0(WD,'/functions/ParetoScaleMatrix.R'))
source(paste0(WD,'/functions/VastScaleMatrix.R'))
source(paste0(WD,'/functions/LevelScaleMatrix.R'))
source(paste0(WD,'/functions/Log10Matrix.R'))
source(paste0(WD,'/functions/PowerMatrix.R'))

```

##### CSS Styling
```{r Styling}
writeLines("td, th { padding : 3px } th { background-color:white; color:black; border:1px solid black; text-align:center } td {color:black; border:1px solid black; word-wrap:break-word; white-space:nowrap; overflow: hidden; text-overflow: ellipsis; max-width:300px; text-align:left}", con= "../css/style.css")
```

### Development Variables
```{r Development Variables}
save_tf <- F
```

# Comparison of Samples and Metabolites Between Sites

## Original Abundances

### Zero/Missing Values in Metabolites (Original Abundances)
```{r Zero/Missing Values in Metabolites (Original Abundances)}
if(T){
# Identify Zero/Missing Values in Metabolites
################################################################################
na_df <- plot_df %>%
  ungroup() %>% 
  group_by(METABOLITE_NAME, STUDY_INSTITUTE_METAB_FAMILY) %>%
  mutate(ZERO_LOG = ifelse(VALUE == 0, 1, 0)) %>%
  mutate(ZERO_N = sum(ZERO_LOG)) %>%
  mutate(ZERO_FREQ = round(ZERO_N/length(shared_sams), digits = 2)) %>%
  mutate(NA_LOG = ifelse(is.na(VALUE), 1, 0)) %>%
  mutate(NA_N = sum(NA_LOG)) %>%
  mutate(NA_FREQ = round(NA_N/length(shared_sams), digits = 2)) %>%
  select(TISSUE,STUDY_INSTITUTE_METAB_FAMILY, METABOLITE_NAME, ZERO_N, ZERO_FREQ, NA_N, NA_FREQ) %>%
  unique() %>%
  arrange(STUDY_INSTITUTE_METAB_FAMILY, desc(NA_FREQ), desc(ZERO_FREQ)) %>%
  ungroup()

na_df %>%
  knitr::kable(format = "html") %>%
  scroll_box(width = "100%", height = "400px")

# Remove Metabolites with high NAor Zero Frequencies
################################################################################
met_rm <- na_df %>%
  filter((ZERO_FREQ >= 0.95) | (NA_FREQ >= 0.8)) %>%
  select(METABOLITE_NAME) %>% unlist() %>% unique()
shared_mets <- shared_mets[shared_mets %!in% met_rm]
plot_df <- plot_df %>%
  mutate(METABOLITE_NAME = as.character(METABOLITE_NAME)) %>%
  filter(METABOLITE_NAME %in% shared_mets)
cor_df <- cor_df %>%
  mutate(METABOLITE_NAME = as.character(METABOLITE_NAME)) %>%
  filter(METABOLITE_NAME %!in% met_rm)
plot_join_df <- plot_join_df %>%
  mutate(METABOLITE_NAME = as.character(METABOLITE_NAME)) %>%
  filter(METABOLITE_NAME %in% shared_mets)
norm_df <- norm_df %>%
  mutate(METABOLITE_NAME = as.character(METABOLITE_NAME)) %>%
  filter(METABOLITE_NAME %in% shared_mets)
norm_join_df <- norm_join_df %>%
  mutate(METABOLITE_NAME = as.character(METABOLITE_NAME)) %>%
  filter(METABOLITE_NAME %in% shared_mets)

print(paste0("Metabolites Removed: ", paste(met_rm, collapse = '; ')))

if(T){
  # Save the dataframe as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  na_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-zero-na-df_steep.rds")
  saveRDS(na_df, file = na_file)
}

}
```

### Boxplots (Original Abundances)
```{r Boxplots (Original Abundances)}
if(F){
# Plot Boxplots faceted by shared metabolites
################################################################################
p <- plot_df %>%
  ggplot(aes(y = METABOLITE_NAME, x = VALUE, color = STUDY_INSTITUTE_METAB_FAMILY)) +
  geom_boxplot(alpha = 0.8) +
  labs(title=paste0(tissue,' ',shared_runs_out,"\n
                    Original Metabolite Abundances"),x = "Abundance", y = "") +
  theme(axis.text.y = element_text(size = 5, angle = 0)) +
  theme(legend.text = element_text(size=8),
        legend.title = element_text(size = 7))
plot(p)

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-boxplot-original_steep.rds")
  saveRDS(p, file = p_file)
}

}
```

### Distributions (Original Abundances)
```{r Distributions (Original Abundances)}
if(F){
# Summary Statistics of Density plot distribution
################################################################################
# Iterate through the runs and collect vectors
df_all <- data.frame()
for(shared_run in shared_runs){
  # Collect numeric vector
  num_vec <- plot_df %>%
    filter(STUDY_INSTITUTE_METAB_FAMILY == shared_run) %>%
    select(VALUE) %>% unlist() %>% unname()
  df <- NumericSummaryStats(num_vec)
  row.names(df) <- shared_run
  df_all <- rbind(df_all, df)
}
row.names(df_all) <- paste(row.names(df_all),tissue, sep ="__")
df_all %>%
  knitr::kable(format = "html") %>%
  scroll_box(width = "100%", height = "200px")

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-summary-stats-original_steep.rds")
  saveRDS(df_all, file = p_file)
}


# Plot the density plot for all the gene counts
################################################################################
p <- plot_df %>%
  ggplot(aes(x = VALUE, color = STUDY_INSTITUTE_METAB_FAMILY)) +
  geom_density() +
  xlim(min(df_all$MIN), mean(df_all$Q3)) +
  labs(title=paste0(tissue,' ',shared_runs_out,":\nOriginal Metabolite Abundances"),
       x = "Abundance",
       y = "Density")
plot(p)

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-density-original_steep.rds")
  saveRDS(p, file = p_file)
}
}
```

### Scatterplots (Original Abundances)
```{r Scatterplots (Original Abundances)}
if(F){
# Plot scatter plots
################################################################################
# Plot scatter plots ordered by sample (include R2 values)
lm_df <- plot_join_df %>%
  rename(name = METABOLITE_NAME) %>%
  rename(x = shared_runs[1]) %>%
  rename(y = shared_runs[2])
# Iterate through each of the shared metabolites to collect summary info about their correlations
r2_df <- data.frame()
for(metab in shared_mets){
  met_df <- lm_df %>%
    filter(name == metab)
  r2_df <- rbind(r2_df, lm_eqn(met_df))
}
# Display summaries
met_r2_df <- r2_df %>%
  arrange(METABOLITE) %>%
  select(METABOLITE,R2) %>%
  arrange(desc(R2))
met_r2_df %>%
  knitr::kable(format = "html") %>%
  scroll_box(width = "100%", height = "200px")
# Collect the order of metabolites
scat_met_order <- met_r2_df %>% select(METABOLITE) %>% unlist() %>% as.character()

# Plot the scatter plots
for(metab in scat_met_order){
  p <- plot_join_df %>%
    filter(METABOLITE_NAME == metab) %>%
  ggplot(aes(x = !!sym(shared_runs[1]), y = !!sym(shared_runs[2])), color = ) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", size = 1) +
  geom_abline(linetype="dashed") +
  facet_wrap(~ METABOLITE_NAME) +
  expand_limits(x = 0, y = 0) +
  #labs(title=paste0(tissue,' ',study_institute_metab_family,": Normalized Metabolite Abundances")) +
  coord_fixed(ratio=1) +
  theme(aspect.ratio=1)
  plot(p)
}
}
```

### Metabolite by Metabolite Correlation (Original Abundances)
```{r Metabolite by Metabolite Correlation (Original Abundances)}
if(F){
################################################################################
####################### Metabolite by Metabolite Correlations ##################
################################################################################

# Subset Matrices
run_mats <- plot_df %>%
  replace_na(list(VALUE = 0)) %>%
  unite(METABOLITE_NAME,STUDY_INSTITUTE_METAB_FAMILY, 
        col = METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  select(METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, labelid, VALUE,STUDY_INSTITUTE_METAB_FAMILY) %>%
  split(.$STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(select, -STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(pivot_wider, names_from = METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, values_from = VALUE) %>%
  map(arrange, labelid) %>%
  map(tibble::column_to_rownames, var = "labelid") %>%
  map(as.matrix)

# Collect matrices
run_mat1 <- run_mats[[1]]
run_mat2 <- run_mats[[2]]
# Sort matrices rows and columns
colord1 <- colnames(run_mat1) %>% sort()
roword1 <- rownames(run_mat1) %>% sort()
run_mat1 <- run_mat1[roword1,colord1]
colord2 <- colnames(run_mat2) %>% sort()
roword2 <- rownames(run_mat2) %>% sort()
run_mat2 <- run_mat2[roword2,colord2]

colord1 <- colord1 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()
colord2 <- colord2 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()

# Subset matrices
if(all(colord1 == colord2) & all(roword1 == roword2)){
  shared_met_mat <-  cbind(run_mat1, run_mat2)
}
Corr <- 'Spearman'
# Create an NxN Matrix of correlation
if(Corr == 'Pearson'){
        cor1 <- stats::cor(shared_met_mat, method = 'pearson') %>% round(digits = 3)
}else if(Corr == 'Spearman'){
        cor1 <- stats::cor(shared_met_mat, method = 'spearman') %>% round(digits = 3)
}

# Reorder the correlation matrix
cormat <- cor1
# Melt the correlation matrix
melted_cormat <- melt(cormat, na.rm = TRUE)

################################################################################
####################### Only Reciprocal Pairs ##################################
################################################################################

# Remove rows that compare metabolites from the same dataset, them remove redundent measurements
melted_cormat2 <- melted_cormat 
# Widen the datafrmae back to matrix
cormat2 <- melted_cormat2 %>%
  pivot_wider(names_from = Var2, values_from = value) %>%
  as.data.frame()
row.names(cormat2) <- cormat2$Var1
cormat2 <- cormat2 %>%
  select(-Var1) %>%
  as.matrix()
cormat2 <- cormat2[sort(rownames(cormat2)),sort(colnames(cormat2))]
cormat2 <- cormat2[grepl(shared_runs[1], rownames(cormat2)),grepl(shared_runs[2], colnames(cormat2))]

# Orient the colors and breaks
paletteLength <- 1000
myColor <- colorRampPalette(c("blue", "white", "red"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(1/paletteLength, max(cor1, na.rm = T), length.out=floor(paletteLength/2)))

# Plot the heatmap
p <- pheatmap(cormat2, color=myColor, breaks=myBreaks,
              main = paste0(tissue,": Shared Samples and Metabolites"),
              cluster_rows = F, cluster_cols = F,fontsize = 4,
              show_rownames = F, show_colnames = F)

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-mxm-original_steep.rds")
  saveRDS(p, file = p_file)
}

}
```

### Sample by Sample Correlations (Original Abundances)
```{r Sample by Sample Correlations (Original Abundances)}
if(F){
################################################################################
####################### Sample by Sample Correlations ##########################
################################################################################

# Subset Data
################################################################################
# Original NxP Matrix
run_mats <- plot_df %>%
  replace_na(list(VALUE = 0)) %>%
  unite(labelid,STUDY_INSTITUTE_METAB_FAMILY, 
        col = labelid_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  select(labelid_STUDY_INSTITUTE_METAB_FAMILY, METABOLITE_NAME, VALUE,STUDY_INSTITUTE_METAB_FAMILY) %>%
  split(.$STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(select, -STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(pivot_wider, names_from = METABOLITE_NAME, values_from = VALUE) %>%
  map(tibble::column_to_rownames, var = "labelid_STUDY_INSTITUTE_METAB_FAMILY") %>%
  map(as.matrix)

# Collect matrices
run_mat1 <- run_mats[[1]]
run_mat2 <- run_mats[[2]]
# Sort matrices rows and columns
colord1 <- colnames(run_mat1) %>% sort()
roword1 <- rownames(run_mat1) %>% sort()
run_mat1 <- run_mat1[roword1,colord1]
colord2 <- colnames(run_mat2) %>% sort()
roword2 <- rownames(run_mat2) %>% sort()
run_mat2 <- run_mat2[roword2,colord2]

roword1 <- roword1 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()
roword2 <- roword2 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()

# Subset matrices
if(all(colord1 == colord2) & all(roword1 == roword2)){
  shared_sam_mat <-  rbind(run_mat1, run_mat2) %>% t()
}

# Create an NxN Matrix of correlation
Corr <- 'Spearman'
if(Corr == 'Pearson'){
        cor1 <- stats::cor(shared_sam_mat, method = 'pearson') %>% round(digits = 3)
}else if(Corr == 'Spearman'){
        cor1 <- stats::cor(shared_sam_mat, method = 'spearman') %>% round(digits = 3)
}

# Melt the correlation matrix
melted_cormat <- melt(cor1, na.rm = TRUE)

################################################################################
####################### Unclustered ############################################
################################################################################

# Remove rows that compare metabolites from the same dataset, them remove redundent measurements
melted_cormat2 <- melted_cormat

# Widen the dataframwe back to matrix
cormat2 <- melted_cormat2 %>%
  pivot_wider(names_from = Var2, values_from = value) %>%
  as.data.frame()
row.names(cormat2) <- cormat2$Var1
cormat2 <- cormat2 %>%
  select(-Var1) %>%
  as.matrix()
cormat2 <- cormat2[sort(rownames(cormat2)),sort(colnames(cormat2))]
cormat2 <- cormat2[grepl(shared_runs[1], rownames(cormat2)),grepl(shared_runs[2], colnames(cormat2))]

# Orient the colors and breaks
paletteLength <- 1000
myColor <- colorRampPalette(c("blue", "white", "red"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(1/paletteLength, max(cor1, na.rm = TRUE), length.out=floor(paletteLength/2)))

# Plot the heatmap
p <- pheatmap(as.matrix(cormat2), color=myColor, breaks=myBreaks,
              main = paste0(tissue,": Shared Samples and Metabolites"),
              cluster_rows = F, cluster_cols = F,fontsize = 4,
              show_rownames = F, show_colnames = F)

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-sxs-original_steep.rds")
  saveRDS(p, file = p_file)
}

}
```

### PCA Analysis (Original Abundances)
```{r PCA Analysis (Original Abundances)}
if(F){
pca <- prcomp(na.omit(t(shared_sam_mat)), scale. = F)
percentVar <- pca$sdev^2/sum(pca$sdev^2)
PC <- pca$x %>% as.data.frame()
PC$labelid_shared_run <- as.character(row.names(pca$x))
PC <- PC %>%
  tidyr::separate(col = labelid_shared_run, into = c('labelid', 'STUDY_INSTITUTE_METAB_FAMILY'),
  sep = "_", remove = T)
# Join the phenotype data
PC <- left_join(PC, pheno_df, by = 'labelid')

p0 <- PC %>%
  ggplot(aes(x = PC1, y = PC2, color=STUDY_INSTITUTE_METAB_FAMILY)) +
  geom_point(size = 3) +
  geom_line(aes(group = labelid),color="dark grey") +
  ggtitle(paste0(tissue,': Shared Samples and Metabolites')) + 
  xlab(paste0('PC1: ',round(percentVar[1]*100,2),'% variance')) +
  ylab(paste0('PC2: ',round(percentVar[2]*100,2),'% variance')) +
  theme(aspect.ratio=1)
p0
p1 <- PC %>%
        ggplot(aes(x = PC1, y = PC2, color=Key.anirandgroup, shape = STUDY_INSTITUTE_METAB_FAMILY)) +
        geom_point(size = 3) +
        geom_line(aes(group = labelid),color="dark grey") +
        ggtitle(paste0(tissue,': Shared Samples and Metabolites')) +
        xlab(paste0('PC1: ',round(percentVar[1]*100,2),'% variance')) +
        ylab(paste0('PC2: ',round(percentVar[2]*100,2),'% variance')) +
        scale_color_manual(values=ec_colors) +
        theme(aspect.ratio=1)
p1
PC$Registration.sex <- as.character(PC$Registration.sex)
p2 <- PC %>%
        ggplot(aes(x = PC1, y = PC2, color=Registration.sex, shape = STUDY_INSTITUTE_METAB_FAMILY)) +
        geom_point(size = 3) +
        geom_line(aes(group = labelid),color="dark grey") +
        ggtitle(paste0(tissue,': Shared Samples and Metabolites')) +
        xlab(paste0('PC1: ',round(percentVar[1]*100,2),'% variance')) +
        ylab(paste0('PC2: ',round(percentVar[2]*100,2),'% variance')) +
        theme(aspect.ratio=1)
p2

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p0_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-pca-original-0_steep.rds")
  saveRDS(p0, file = p0_file)
  p1_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-pca-original-1_steep.rds")
  saveRDS(p1, file = p1_file)
  p2_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-pca-original-2_steep.rds")
  saveRDS(p2, file = p2_file)
}

}
```

## Normalized Abundances

### Boxplots (Normalized Abundances)
```{r Boxplots (Normalized Abundances)}
if(F){
# Plot Boxplots faceted by shared metabolites
################################################################################
p <- norm_df %>%
  ggplot(aes(y = METABOLITE_NAME, x = VALUE, color = STUDY_INSTITUTE_METAB_FAMILY)) +
  geom_boxplot(alpha = 0.8) +
  labs(title=paste0(tissue,' ',shared_runs_out,":\nNormalized Metabolite Abundances"),
             x = "Abundance", y = "") +
  theme(axis.text=element_text(size=6))
plot(p)

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-boxplot-normalized_steep.rds")
  saveRDS(p, file = p_file)
}

}
```

### Distributions (Normalized Abundances)
```{r Distributions (Normalized Abundances)}
if(F){
# Plot the density plot for all the gene counts
################################################################################
p <- norm_df %>%
  ggplot(aes(x = VALUE, color = STUDY_INSTITUTE_METAB_FAMILY)) +
  geom_density() +
  labs(title=paste0(tissue,' ',shared_runs_out,":\nNormalized Metabolite Abundances"),
       x = "Abundance",
       y = "Density")
plot(p)

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-density-normalized_steep.rds")
  saveRDS(p, file = p_file)
}

# Summary Statistics of Density plot distribution
################################################################################
# Iterate through the runs and collect vectors
df_all <- data.frame()
for(shared_run in shared_runs){
  # Collect numeric vector
  num_vec <- norm_df %>%
    filter(STUDY_INSTITUTE_METAB_FAMILY == shared_run) %>%
    select(VALUE) %>% unlist() %>% unname()
  df <- NumericSummaryStats(num_vec)
  row.names(df) <- shared_run
  df_all <- rbind(df_all, df)
}
df_all$TISSUE <- tissue
df_all %>%
  knitr::kable(format = "html") %>%
  scroll_box(width = "100%", height = "200px")
#}

if(save_tf){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-summary-stats-normalized_steep.rds")
  saveRDS(df_all, file = p_file)
}

}
```

### Scatterplots (Normalized Abundances)
```{r Scatterplots (Normalized Abundances)}
if(F){
# Normalize
# Subset the data for sites to compare (scatterplots)
###################################################
# Plot scatter plots ordered by sample (include R2 values)
lm_df <- norm_join_df %>%
  rename(name = METABOLITE_NAME) %>%
  rename(x = shared_runs[1]) %>%
  rename(y = shared_runs[2])
# Iterate through each of the shared metabolites to collect summary info about their correlations
r2_df <- data.frame()
for(metab in shared_mets){
  met_df <- lm_df %>%
    filter(name == metab)
  r2_df <- rbind(r2_df, lm_eqn(met_df))
}
# Display summaries
met_r2_df <- r2_df %>%
  arrange(METABOLITE) %>%
  select(METABOLITE,R2) %>%
  arrange(desc(R2))
met_r2_df %>%
  knitr::kable(format = "html") %>%
  scroll_box(width = "100%", height = "200px")

# Collect the order of metabolites
scat_met_order <- met_r2_df %>% select(METABOLITE) %>% unlist() %>% as.character()

# Plot scatter plots (Normalized)
################################################################################
# Plot the scatter plots
for(metab in scat_met_order){
  p <- norm_join_df %>%
    filter(METABOLITE_NAME == metab) %>%
    ggplot(aes(x = !!sym(shared_runs[1]), y = !!sym(shared_runs[2])), color = ) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", size = 1) +
    geom_abline(linetype="dashed") +
    facet_wrap(~ METABOLITE_NAME) +
    expand_limits(x = 0, y = 0) +
    #labs(title=paste0(tissue,' ',study_institute_metab_family,": Normalized Metabolite Abundances")) +
    coord_fixed(ratio=1) +
    theme(aspect.ratio = 1)
  plot(p)
}

}
```

### Metabolite by Metabolite Correlation (Normalized Abundances)
```{r Metabolite by Metabolite Correlation (Normalized Abundances)}
if(T){

################################################################################
####################### Metabolite by Metabolite Correlations ##################
################################################################################
# Subset Matrices
run_mats <- plot_df %>%
  replace_na(list(VALUE = 0)) %>%
  unite(METABOLITE_NAME,STUDY_INSTITUTE_METAB_FAMILY, 
        col = METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  select(METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, labelid, VALUE,STUDY_INSTITUTE_METAB_FAMILY) %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY, 
                        levels = c(shared_runs[1], shared_runs[2], shared_runs[3]))) %>%
  split(.$STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(select, -STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(pivot_wider, names_from = METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, values_from = VALUE) %>%
  map(arrange, labelid) %>%
  map(tibble::column_to_rownames, var = "labelid") %>%
  map(as.matrix) %>%
  map(AutoScaleMatrix)

# Collect matrices
run_mat1 <- run_mats[[1]]
run_mat2 <- run_mats[[2]]
run_mat3 <- run_mats[[3]]

# Sort matrices rows and columns
colord1 <- colnames(run_mat1) %>% sort()
roword1 <- rownames(run_mat1) %>% sort()
run_mat1 <- run_mat1[roword1,colord1]
colord2 <- colnames(run_mat2) %>% sort()
roword2 <- rownames(run_mat2) %>% sort()
run_mat2 <- run_mat2[roword2,colord2]
colord3 <- colnames(run_mat3) %>% sort()
roword3 <- rownames(run_mat3) %>% sort()
run_mat3 <- run_mat3[roword3,colord3]

colord1 <- colord1 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()
colord2 <- colord2 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()
colord3 <- colord3 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()

# Subset matrices
if(all(colord1 == colord2) & all(colord1 == colord3) & 
   all(roword1 == roword2) & all(roword1 == roword3)){
  shared_met_mat1 <-  cbind(run_mat1, run_mat2)
  shared_met_mat2 <- cbind(run_mat1, run_mat3)
  shared_met_mat3 <- cbind(run_mat2, run_mat3)
}

Corr <- 'Spearman'
# Create an NxN Matrix of correlation
if(Corr == 'Pearson'){
        cor1 <- stats::cor(shared_met_mat1, method = 'pearson') %>% round(digits = 3)
}else if(Corr == 'Spearman'){
        cor1 <- stats::cor(shared_met_mat1, method = 'spearman') %>% round(digits = 3)
        cor2 <- stats::cor(shared_met_mat2, method = 'spearman') %>% round(digits = 3)
        cor3 <- stats::cor(shared_met_mat3, method = 'spearman') %>% round(digits = 3)
}

# Sort and filter the rows and columns to compare reciprocal pairs
cor1 <- cor1[sort(rownames(cor1)),sort(colnames(cor1))]
cor1 <- cor1[grepl(shared_runs[1], rownames(cor1)),grepl(shared_runs[2], colnames(cor1))]
cor2 <- cor2[sort(rownames(cor2)),sort(colnames(cor2))]
cor2 <- cor2[grepl(shared_runs[1], rownames(cor2)),grepl(shared_runs[3], colnames(cor2))]
cor3 <- cor3[sort(rownames(cor3)),sort(colnames(cor3))]
cor3 <- cor3[grepl(shared_runs[2], rownames(cor3)),grepl(shared_runs[3], colnames(cor3))]

# Orient colors, breaks, and annotations
############################
paletteLength <- 1000
myColor <- colorRampPalette(c("blue", "white", "red"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(1/paletteLength, 1, length.out=floor(paletteLength/2)))
# Annotation colors
ann_colors <- list(
  ThreeHIB = c('0' = 'gray100', '1' = 'orangered1'),
  Amino_Acids = c('0' = 'gray100', '1' = 'royalblue4'),
  Acylcarnitines = c('0' = 'gray100', '1' = 'green4'),
  Acyl_CoAs = c('0' = 'gray100', '1' = 'darkorchid'),
  Amines = c('0' = 'gray100', '1' = 'darkslategray4'),
  BAIBA = c('0' = 'gray100', '1' = 'lightgreen'),
  Ceramides = c('0' = 'gray100', '1' = 'lightsalmon'),
  Keto_Acids = c('0' = 'gray100', '1' = 'gold'),
  Nucleotides = c('0' = 'gray100', '1' = 'purple'),
  Organic_Acids = c('0' = 'gray100', '1' = 'navy'),
  Sphingomyelins = c('0' = 'gray100', '1' = 'violet'),
  TCA = c('0' = 'gray100', '1' = 'coral'),
  Targeted = c('0' = 'gray100', '1' = 'grey10')
)

# Metabolite Families
#######################
# Generate annotations (row bars)
# cor <- cor1
i <- 1
# i <- 2

for(cor in list(cor1,cor2,cor3)){
  # Generate the correct comparisons
  if(i == 1){
  shared_runs1 <- shared_runs[1]
  shared_runs2 <- shared_runs[2]
}else if(i == 2){
  shared_runs1 <- shared_runs[1]
  shared_runs2 <- shared_runs[3]
}else if(i == 3){
  shared_runs1 <- shared_runs[2]
  shared_runs2 <- shared_runs[3]
}
  
  row_ann_df <- plot_df %>%
  unite(METABOLITE_NAME,STUDY_INSTITUTE_METAB_FAMILY, 
        col = METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  left_join(y = all_met_df, by = 'METABOLITE_NAME') %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY)) %>%
  select(-DATASET,-TISSUE,-STUDY_INSTITUTE_METAB_FAMILY,-NAMED,
         -CH_CHROMATOGRAPHY_TYPE,-MS_TYPE,-MS_ION_MODE,-labelid,
         -viallabel,-pid,-bid,-VALUE,-SAMPLE_DATA,-METABOLITE_DATA) %>%
  mutate(Targeted = ifelse(is.na(METABOLITE_SET), '0', '1')) %>%
  replace(is.na(.), '0') %>%
  select(-METABOLITE_SET) %>%
  filter(METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY %in% rownames(cor)) %>%
  unique() %>%
  mutate(ThreeHIB = as.numeric(ThreeHIB)) %>%
  mutate(Amino_Acids = as.numeric(Amino_Acids)) %>%
  mutate(Acylcarnitines = as.numeric(Acylcarnitines)) %>%
  mutate(Acyl_CoAs = as.numeric(Acyl_CoAs)) %>%
  mutate(Amines = as.numeric(Amines)) %>%
  mutate(BAIBA = as.numeric(BAIBA)) %>%
  mutate(Ceramides = as.numeric(Ceramides)) %>%
  mutate(Keto_Acids = as.numeric(Keto_Acids)) %>%
  mutate(Nucleotides = as.numeric(Nucleotides)) %>%
  mutate(Organic_Acids = as.numeric(Organic_Acids)) %>%
  mutate(Sphingomyelins = as.numeric(Sphingomyelins)) %>%
  mutate(TCA = as.numeric(TCA)) %>%
  mutate(Targeted = as.numeric(Targeted))
kc <- colSums(row_ann_df %>% 
          select(-METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY,-METABOLITE_NAME)) %>% sort() %>% rev()
kc <- names(kc[kc>0])
ord <- kc[kc != 'Targeted']

row_ann_df <- row_ann_df %>%
  mutate(ThreeHIB = as.factor(ThreeHIB)) %>%
  mutate(Amino_Acids = as.factor(Amino_Acids)) %>%
  mutate(Acylcarnitines = as.factor(Acylcarnitines)) %>%
  mutate(Acyl_CoAs = as.factor(Acyl_CoAs)) %>%
  mutate(Amines = as.factor(Amines)) %>%
  mutate(BAIBA = as.factor(BAIBA)) %>%
  mutate(Ceramides = as.factor(Ceramides)) %>%
  mutate(Keto_Acids = as.factor(Keto_Acids)) %>%
  mutate(Nucleotides = as.factor(Nucleotides)) %>%
  mutate(Organic_Acids = as.factor(Organic_Acids)) %>%
  mutate(Sphingomyelins = as.factor(Sphingomyelins)) %>%
  mutate(TCA = as.factor(TCA)) %>%
  mutate(Targeted = as.factor(Targeted))

if(length(ord) == 1){
  row_ann_df <- row_ann_df %>%
    select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
    arrange(desc(!!sym(ord[1])), METABOLITE_NAME)
}else if(length(ord) == 2){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), METABOLITE_NAME)
}else if(length(ord) == 3){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])), METABOLITE_NAME)
}else if(length(ord) == 4){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])), METABOLITE_NAME)
}else if(length(ord) == 5){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), METABOLITE_NAME)
}else if(length(ord) == 6){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])), METABOLITE_NAME)
}else if(length(ord) == 7){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])),
          desc(!!sym(ord[7])), METABOLITE_NAME)
}else if(length(ord) == 8){
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])),
          desc(!!sym(ord[7])), desc(!!sym(ord[8])), METABOLITE_NAME)
}else if(length(ord) == 9){  
  row_ann_df <- row_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])),
          desc(!!sym(ord[7])), desc(!!sym(ord[8])), desc(!!sym(ord[9])), METABOLITE_NAME)
}

# Generate annotations (column bars)
col_ann_df <- plot_df %>%
  unite(METABOLITE_NAME,STUDY_INSTITUTE_METAB_FAMILY, 
        col = METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  left_join(y = all_met_df, by = 'METABOLITE_NAME') %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY)) %>%
  select(-DATASET,-TISSUE,-STUDY_INSTITUTE_METAB_FAMILY,-NAMED,
         -CH_CHROMATOGRAPHY_TYPE,-MS_TYPE,-MS_ION_MODE,-labelid,
         -viallabel,-pid,-bid,-VALUE,-SAMPLE_DATA,-METABOLITE_DATA) %>%
  mutate(Targeted = ifelse(is.na(METABOLITE_SET), '0', '1')) %>%
  replace(is.na(.), '0') %>%
  select(-METABOLITE_SET) %>%
  filter(METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY %in% colnames(cor)) %>%
  unique() %>%
  mutate(ThreeHIB = as.numeric(ThreeHIB)) %>%
  mutate(Amino_Acids = as.numeric(Amino_Acids)) %>%
  mutate(Acylcarnitines = as.numeric(Acylcarnitines)) %>%
  mutate(Acyl_CoAs = as.numeric(Acyl_CoAs)) %>%
  mutate(Amines = as.numeric(Amines)) %>%
  mutate(BAIBA = as.numeric(BAIBA)) %>%
  mutate(Ceramides = as.numeric(Ceramides)) %>%
  mutate(Keto_Acids = as.numeric(Keto_Acids)) %>%
  mutate(Nucleotides = as.numeric(Nucleotides)) %>%
  mutate(Organic_Acids = as.numeric(Organic_Acids)) %>%
  mutate(Sphingomyelins = as.numeric(Sphingomyelins)) %>%
  mutate(TCA = as.numeric(TCA)) %>%
  mutate(Targeted = as.numeric(Targeted))
kc <- colSums(col_ann_df %>% 
          select(-METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY,-METABOLITE_NAME)) %>% sort() %>% rev()
kc <- names(kc[kc>0])
ord2 <- kc[kc != 'Targeted']

col_ann_df <- col_ann_df %>%
  mutate(ThreeHIB = as.factor(ThreeHIB)) %>%
  mutate(Amino_Acids = as.factor(Amino_Acids)) %>%
  mutate(Acylcarnitines = as.factor(Acylcarnitines)) %>%
  mutate(Acyl_CoAs = as.factor(Acyl_CoAs)) %>%
  mutate(Amines = as.factor(Amines)) %>%
  mutate(BAIBA = as.factor(BAIBA)) %>%
  mutate(Ceramides = as.factor(Ceramides)) %>%
  mutate(Keto_Acids = as.factor(Keto_Acids)) %>%
  mutate(Nucleotides = as.factor(Nucleotides)) %>%
  mutate(Organic_Acids = as.factor(Organic_Acids)) %>%
  mutate(Sphingomyelins = as.factor(Sphingomyelins)) %>%
  mutate(TCA = as.factor(TCA)) %>%
  mutate(Targeted = as.factor(Targeted))

if(length(ord) == 1){
  col_ann_df <- col_ann_df %>%
    select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
    arrange(desc(!!sym(ord[1])), METABOLITE_NAME)
}else if(length(ord) == 2){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), METABOLITE_NAME)
}else if(length(ord) == 3){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])), METABOLITE_NAME)
}else if(length(ord) == 4){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])), METABOLITE_NAME)
}else if(length(ord) == 5){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), METABOLITE_NAME)
}else if(length(ord) == 6){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])), METABOLITE_NAME)
}else if(length(ord) == 7){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])),
          desc(!!sym(ord[7])), METABOLITE_NAME)
}else if(length(ord) == 8){
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])),
          desc(!!sym(ord[7])), desc(!!sym(ord[8])), METABOLITE_NAME)
}else if(length(ord) == 9){  
  col_ann_df <- col_ann_df %>%
  select("METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY","METABOLITE_NAME",all_of(kc)) %>%
  arrange(desc(!!sym(ord[1])), desc(!!sym(ord[2])), desc(!!sym(ord[3])),
          desc(!!sym(ord[4])),desc(!!sym(ord[5])), desc(!!sym(ord[6])),
          desc(!!sym(ord[7])), desc(!!sym(ord[8])), desc(!!sym(ord[9])), METABOLITE_NAME)
}
# Reorder
r <- unique(row_ann_df$METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY) %>%
  str_remove_all(pattern = paste0('_',shared_runs1))
c <- unique(col_ann_df$METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY) %>%
  str_remove_all(pattern = paste0('_',shared_runs2))

if(all(r == c)){
cor <- cor[unique(row_ann_df$METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY), 
             unique(col_ann_df$METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY)]
}
# Last minute adjustment of the annotation
row_ann_df <- row_ann_df %>% as.data.frame()
row.names(row_ann_df) <- unique(row_ann_df$METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY)
row_ann_df <- row_ann_df %>%
  #mutate(Site_Platform = factor(shared_runs1, levels = shared_runs)) %>%
  select(-METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, -METABOLITE_NAME,-Targeted)
col_ann_df <- col_ann_df %>% as.data.frame()
row.names(col_ann_df) <- unique(col_ann_df$METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY)
col_ann_df <- col_ann_df %>%
  #mutate(Site_Platform = factor(shared_runs2, levels = shared_runs)) %>%
  select(-METABOLITE_NAME_STUDY_INSTITUTE_METAB_FAMILY, -METABOLITE_NAME,-Targeted)

# Reorder the heatmap
z <- heatmap(x = cor1, col = myColor, symm = TRUE)
row_order <- rev(z$rowInd)
col_order <- rev(z$colInd)
cor1 <- cor1[row_order, col_order]

# Plot the heatmap
p <- pheatmap(cor, color=myColor, breaks=myBreaks,
              main = paste0(toupper(tissue)," (",length(r),"x",length(r),"): \n",shared_runs2," \n",shared_runs1),
              cluster_rows = F, cluster_cols = F,fontsize = 16,
              show_rownames = F, show_colnames = F,
              #annotation_colors = ann_colors,
              #annotation_row = row_ann_df,
              #annotation_col = col_ann_df,
              annotation_names_col = F, annotation_names_row = F,
              annotation_legend = F, 
              legend = F, drop_levels = T)

data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
pdf_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-mxm-normalized-triple-",
                   as.character(i),"_steep.pdf")
save_pheatmap_pdf(p, filename = pdf_file)

# Save the correlation matrix values values
#rn <- 3

all_rank_df <- data.frame()
for(rn in 1:nrow(cor)){
  r_met <- rownames(cor)[rn] %>% str_remove_all(pattern = paste0('_',shared_runs1))
  # c_mets <- colnames(cor) %>% str_remove_all(pattern = paste0('_',shared_runs[2]))
  rank <- data.frame(P = cor[rn,] %>% sort() %>% rev()) %>%
    rownames_to_column( var = "METABOLITE_NAME_STUDY_INSTITUTE") %>%
    rowid_to_column("RANK") %>%
    mutate(METABOLITE_NAME = METABOLITE_NAME_STUDY_INSTITUTE %>%
             str_remove_all(pattern = paste0('_',shared_runs2))) %>%
    filter(METABOLITE_NAME == r_met) %>%
    select(RANK) %>% unlist() %>% as.numeric()
  comparison <- paste0(shared_runs1,';',shared_runs2)
  rank_df <- data.frame(METABOLITE_NAME = r_met, RANK = rank, TISSUE = tissue,
                        RUN = shared_run_vec, COMPARISON = comparison)
  all_rank_df <- rbind(all_rank_df, rank_df)
}

if(T){
  # Save as an R object
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  p_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-mxm-triple-",
                   as.character(i),"_steep.rds")
  saveRDS(p, file = p_file)
  r_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-mxm-triple-",
                   as.character(i),"-rank-df_steep.rds")
  saveRDS(all_rank_df, file = r_file)
}
i <- i + 1
}# Iterates over each one of the correlation matrixes

}
```


### Sample by Sample Correlations (Normalized Abundances)
```{r Sample by Sample Correlations (Normalized Abundances)}
if(T){

################################################################################
####################### Sample by Sample Correlations ##########################
################################################################################

# Subset Data
################################################################################
# Original NxP Matrix
run_mats <- plot_df %>%
  replace_na(list(VALUE = 0)) %>%
  unite(labelid,STUDY_INSTITUTE_METAB_FAMILY, 
        col = labelid_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  select(labelid_STUDY_INSTITUTE_METAB_FAMILY, METABOLITE_NAME, VALUE,STUDY_INSTITUTE_METAB_FAMILY) %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY, 
                        levels = c(shared_runs[1], shared_runs[2], shared_runs[3]))) %>%
  split(.$STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(select, -STUDY_INSTITUTE_METAB_FAMILY) %>%
  map(pivot_wider, names_from = METABOLITE_NAME, values_from = VALUE) %>%
  map(tibble::column_to_rownames, var = "labelid_STUDY_INSTITUTE_METAB_FAMILY") %>%
  map(as.matrix) %>%
  map(AutoScaleMatrix)

# Collect matrices
run_mat1 <- run_mats[[1]]
run_mat2 <- run_mats[[2]]
run_mat3 <- run_mats[[3]]

# Sort matrices rows and columns
colord1 <- colnames(run_mat1) %>% sort()
roword1 <- rownames(run_mat1) %>% sort()
run_mat1 <- run_mat1[roword1,colord1]
colord2 <- colnames(run_mat2) %>% sort()
roword2 <- rownames(run_mat2) %>% sort()
run_mat2 <- run_mat2[roword2,colord2]
colord3 <- colnames(run_mat3) %>% sort()
roword3 <- rownames(run_mat3) %>% sort()
run_mat3 <- run_mat3[roword3,colord3]

roword1 <- roword1 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()
roword2 <- roword2 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()
roword3 <- roword3 %>% str_split(pattern = '_') %>% map(head , 1) %>% unlist()

# Subset matrices
if(all(colord1 == colord2) & all(colord1 == colord3) & 
   all(roword1 == roword2) & all(roword1 == roword3)){
  shared_sam_mat1 <-  rbind(run_mat1, run_mat2) %>% t()
  shared_sam_mat2 <-  rbind(run_mat1, run_mat3) %>% t()
  shared_sam_mat3 <-  rbind(run_mat2, run_mat3) %>% t()
}

# Create an NxN Matrix of correlation
Corr <- 'Spearman'
if(Corr == 'Pearson'){
        cor1 <- stats::cor(shared_sam_mat1, method = 'pearson') %>% round(digits = 3)
}else if(Corr == 'Spearman'){
        cor1 <- stats::cor(shared_sam_mat1, method = 'spearman') %>% round(digits = 3)
        cor2 <- stats::cor(shared_sam_mat2, method = 'spearman') %>% round(digits = 3)
        cor3 <- stats::cor(shared_sam_mat3, method = 'spearman') %>% round(digits = 3)
}

cor1 <- cor1[sort(rownames(cor1)),sort(colnames(cor1))]
cor1 <- cor1[grepl(shared_runs[1], rownames(cor1)),grepl(shared_runs[2], colnames(cor1))]
cor2 <- cor2[sort(rownames(cor2)),sort(colnames(cor2))]
cor2 <- cor2[grepl(shared_runs[1], rownames(cor2)),grepl(shared_runs[3], colnames(cor2))]
cor3 <- cor3[sort(rownames(cor3)),sort(colnames(cor3))]
cor3 <- cor3[grepl(shared_runs[2], rownames(cor3)),grepl(shared_runs[3], colnames(cor3))]

# Orient the colors, breaks, and annotations
#####################
paletteLength <- 1000
myColor <- colorRampPalette(c("blue", "white", "red"))(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(1/paletteLength, 1, length.out=floor(paletteLength/2)))
# Annotation order
factor_order <- c('Exercise - IPE',
               'Exercise - 0.5 hr',
               'Exercise - 1 hr',
               'Exercise - 4 hr',
               'Exercise - 7 hr',
               'Exercise - 24 hr',
               'Exercise - 48 hr',
               'Control - IPE',
               'Control - 7 hr')
# Annotation colors
ann_colors <- list(
  Exercise_Group = c('Exercise - IPE' = 'gold',
                     'Exercise - 0.5 hr' = 'darkgoldenrod1',
                     'Exercise - 1 hr' = 'orange',
                     'Exercise - 4 hr' = 'darkorange',
                     'Exercise - 7 hr' = 'darkorange2',
                     'Exercise - 24 hr' = 'darkorange3',
                     'Exercise - 48 hr' = 'darkorange4',
                     'Control - IPE' = 'steelblue1',
                     'Control - 7 hr' = 'steelblue4'),
  Sex = c('1' = "#00BFC4", "2" = "#F8766D")
)

# Sex then exercise
#######################
# Generate annotations (row bars)
#cor <- cor1
i <- 1
for(cor in list(cor1,cor2,cor3)){
  # Generate the correct comparisons
  if(i == 1){
  shared_runs1 <- shared_runs[1]
  shared_runs2 <- shared_runs[2]
}else if(i == 2){
  shared_runs1 <- shared_runs[1]
  shared_runs2 <- shared_runs[3]
}else if(i == 3){
  shared_runs1 <- shared_runs[2]
  shared_runs2 <- shared_runs[3]
}
  
# Generate annotations (row bars)
row_ann_df <- plot_df %>%
  unite(labelid,STUDY_INSTITUTE_METAB_FAMILY, 
        col = labelid_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  left_join(y = pheno_df, by = 'labelid') %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY)) %>%
  mutate(Registration.sex = factor(Registration.sex)) %>%
  select(labelid_STUDY_INSTITUTE_METAB_FAMILY,Key.anirandgroup, STUDY_INSTITUTE_METAB_FAMILY,Registration.sex) %>%
  filter(labelid_STUDY_INSTITUTE_METAB_FAMILY %in% rownames(cor)) %>%
  unique() %>%
  dplyr::rename(Exercise_Group = Key.anirandgroup) %>%
  dplyr::rename(Sex = Registration.sex) %>%
  arrange(Sex,
          factor(Exercise_Group, levels = factor_order), 
          desc(labelid_STUDY_INSTITUTE_METAB_FAMILY)) %>% 
  column_to_rownames(var = "labelid_STUDY_INSTITUTE_METAB_FAMILY") %>%
  select(-STUDY_INSTITUTE_METAB_FAMILY)

# Generate annotations (column bars)
col_ann_df <- plot_df %>%
  unite(labelid,STUDY_INSTITUTE_METAB_FAMILY, 
        col = labelid_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  left_join(y = pheno_df, by = 'labelid') %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY)) %>%
  mutate(Registration.sex = factor(Registration.sex)) %>%
  select(labelid_STUDY_INSTITUTE_METAB_FAMILY,Key.anirandgroup, STUDY_INSTITUTE_METAB_FAMILY,Registration.sex) %>%
  filter(labelid_STUDY_INSTITUTE_METAB_FAMILY %in% colnames(cor)) %>%
  unique() %>%
  dplyr::rename(Exercise_Group = Key.anirandgroup) %>%
  dplyr::rename(Sex = Registration.sex) %>%
  arrange(Sex,
          factor(Exercise_Group, levels = factor_order), 
          desc(labelid_STUDY_INSTITUTE_METAB_FAMILY)) %>% 
  column_to_rownames(var = "labelid_STUDY_INSTITUTE_METAB_FAMILY") %>%
  select(-STUDY_INSTITUTE_METAB_FAMILY)

# Reorder
r <- row.names(row_ann_df) %>%
  str_remove_all(pattern = paste0('_',shared_runs1))
c <- row.names(col_ann_df) %>%
  str_remove_all(pattern = paste0('_',shared_runs2))

if(all(r == c)){
  cor <- cor[row.names(row_ann_df), row.names(col_ann_df)]
}

# Plot the heatmap
p1 <- pheatmap(cor, color=myColor, breaks=myBreaks,
              main = paste0(toupper(tissue)," (",nrow(cor),"x",nrow(cor),"): \n",shared_runs2," \n",shared_runs1),
              cluster_rows = F, cluster_cols = F,fontsize = 16,
              show_rownames = F, show_colnames = F,
              annotation_colors = ann_colors,
              annotation_row = row_ann_df,
              annotation_col = col_ann_df,
              annotation_names_col = F, annotation_names_row = F,
              annotation_legend = F, legend = F)

# Save the correlation matrix values values
#rn <- 1
all_rank_df <- data.frame()
for(rn in 1:nrow(cor)){
  r_sam <- rownames(cor)[rn] %>% str_remove_all(pattern = paste0('_',shared_runs1))
  rank <- data.frame(P = cor[rn,] %>% sort() %>% rev()) %>%
    rownames_to_column( var = "labelid_STUDY_INSTITUTE") %>%
    rowid_to_column("RANK") %>%
    mutate(labelid = labelid_STUDY_INSTITUTE %>%
             str_remove_all(pattern = paste0('_',shared_runs2))) %>%
    filter(labelid == r_sam) %>%
    select(RANK) %>% unlist() %>% as.numeric()
  comparison <- paste0(shared_runs1,';',shared_runs2)
  rank_df <- data.frame(labelid = r_sam, RANK = rank, TISSUE = tissue,
                        RUN = shared_run_vec,  COMPARISON = comparison)
  all_rank_df <- rbind(all_rank_df, rank_df)
}

# Exercise then sex
#######################
# Generate annotations (row bars)
row_ann_df <- plot_df %>%
  unite(labelid,STUDY_INSTITUTE_METAB_FAMILY, 
        col = labelid_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  left_join(y = pheno_df, by = 'labelid') %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY)) %>%
  mutate(Registration.sex = factor(Registration.sex)) %>%
  select(labelid_STUDY_INSTITUTE_METAB_FAMILY,Key.anirandgroup, STUDY_INSTITUTE_METAB_FAMILY,Registration.sex) %>%
  filter(labelid_STUDY_INSTITUTE_METAB_FAMILY %in% rownames(cor)) %>%
  unique() %>%
  rename(Exercise_Group = Key.anirandgroup) %>%
  rename(Sex = Registration.sex) %>%
  arrange(factor(Exercise_Group, levels = factor_order),
          Sex, 
          desc(labelid_STUDY_INSTITUTE_METAB_FAMILY)) %>% 
  column_to_rownames(var = "labelid_STUDY_INSTITUTE_METAB_FAMILY") %>%
  select(-STUDY_INSTITUTE_METAB_FAMILY)

# Generate annotations (column bars)
col_ann_df <- plot_df %>%
  unite(labelid,STUDY_INSTITUTE_METAB_FAMILY, 
        col = labelid_STUDY_INSTITUTE_METAB_FAMILY, remove = F) %>%
  left_join(y = pheno_df, by = 'labelid') %>%
  mutate(STUDY_INSTITUTE_METAB_FAMILY = factor(STUDY_INSTITUTE_METAB_FAMILY)) %>%
  mutate(Registration.sex = factor(Registration.sex)) %>%
  select(labelid_STUDY_INSTITUTE_METAB_FAMILY,Key.anirandgroup, STUDY_INSTITUTE_METAB_FAMILY,Registration.sex) %>%
  filter(labelid_STUDY_INSTITUTE_METAB_FAMILY %in% colnames(cor)) %>%
  unique() %>%
  rename(Exercise_Group = Key.anirandgroup) %>%
  rename(Sex = Registration.sex) %>%
  arrange(factor(Exercise_Group, levels = factor_order),
          Sex, 
          desc(labelid_STUDY_INSTITUTE_METAB_FAMILY)) %>% 
  column_to_rownames(var = "labelid_STUDY_INSTITUTE_METAB_FAMILY") %>%
  select(-STUDY_INSTITUTE_METAB_FAMILY)

# Reorder
r <- row.names(row_ann_df) %>%
  str_remove_all(pattern = paste0('_',shared_runs1))
c <- row.names(col_ann_df) %>%
  str_remove_all(pattern = paste0('_',shared_runs2))

if(all(r == c)){
  cor <- cor[row.names(row_ann_df), row.names(col_ann_df)]
}

# Plot the heatmap
p2 <- pheatmap(cor, color=myColor, breaks=myBreaks,
              main = paste0(toupper(tissue)," (",nrow(cor),"x",nrow(cor),"): \n",shared_runs2," \n",shared_runs1),
              cluster_rows = F, cluster_cols = F,fontsize = 16,
              show_rownames = F, show_colnames = F,
              annotation_colors = ann_colors,
              annotation_row = row_ann_df,
              annotation_col = col_ann_df,
              annotation_names_col = F, annotation_names_row = F,
              annotation_legend = F, legend = F)

if(T){
  # Create the directory to save files
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  # Save Data as R Objects
  ####################################
  # d_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-sxs-normalized-data_steep.rds")
  # saveRDS(d, file = d_file)
  # Save as an R object
  ####################################
  p1_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-sxs-normalized-se_steep.rds")
  saveRDS(p1, file = p1_file)
  p2_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-sxs-normalized-es_steep.rds")
  saveRDS(p2, file = p2_file)
  # Save the ranks
  ########################
  r_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-sxs-normalized-rank-df_steep.rds")
  saveRDS(all_rank_df, file = r_file)
} # The save files conditional
i <- i + 1
} # The 3 correlation matrices
} # True/False statement
```

### PCA Analysis (Normalized Abundances)
```{r PCA Analysis (Normalized Abundances)}
if(F){
# Plot a PCA with outliers labeled
# shared_sam_mat <- shared_sam_mat %>%
#   t() %>% AutoScaleMatrix() %>%
#   t()
pca <- prcomp(na.omit(t(shared_sam_mat)), scale. = F)
percentVar <- pca$sdev^2/sum(pca$sdev^2)
PC <- pca$x %>% as.data.frame()
PC$labelid_shared_run <- as.character(row.names(pca$x))
PC <- PC %>%
  tidyr::separate(col = labelid_shared_run, into = c('labelid', 'STUDY_INSTITUTE_METAB_FAMILY'),
  sep = "_", remove = T)
# Join the phenotype data
PC <- left_join(PC, pheno_df, by = 'labelid')

p0 <- PC %>%
  ggplot(aes(x = PC1, y = PC2, color=STUDY_INSTITUTE_METAB_FAMILY)) +
  geom_point(size = 3) +
  geom_line(aes(group = labelid),color="dark grey") +
  ggtitle(paste0(tissue,': Shared Samples and Metabolites')) +
  xlab(paste0('PC1: ',round(percentVar[1]*100,2),'% variance')) +
  ylab(paste0('PC2: ',round(percentVar[2]*100,2),'% variance')) +
  theme(aspect.ratio=1)
p0

p1 <- PC %>%
        ggplot(aes(x = PC1, y = PC2, color=Key.anirandgroup, shape = STUDY_INSTITUTE_METAB_FAMILY)) +
        geom_point(size = 3) +
  geom_line(aes(group = labelid),color="dark grey") +
        ggtitle(paste0(tissue,': Shared Samples and Metabolites')) +
        xlab(paste0('PC1: ',round(percentVar[1]*100,2),'% variance')) +
        ylab(paste0('PC2: ',round(percentVar[2]*100,2),'% variance')) +
        scale_color_manual(values=ec_colors) +
        theme(aspect.ratio=1)
p1
PC$Registration.sex <- as.character(PC$Registration.sex)
p2 <- PC %>%
        ggplot(aes(x = PC1, y = PC2, color=Registration.sex, shape = STUDY_INSTITUTE_METAB_FAMILY)) +
        geom_point(size = 3) +
  geom_line(aes(group = labelid),color="dark grey") +
        ggtitle(paste0(tissue,': Shared Samples and Metabolites')) +
        xlab(paste0('PC1: ',round(percentVar[1]*100,2),'% variance')) +
        ylab(paste0('PC2: ',round(percentVar[2]*100,2),'% variance')) +
        theme(aspect.ratio=1)
p2

if(save_tf){
  # Create data Directory
  ####################################
  data_dir <- paste0(WD,"/data/site_comparisons/",shared_runs_out)
  cmd <- paste0("mkdir -p ",data_dir)
  system(cmd)
  # Save Plots as an R object
  ####################################
  p0_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-pca-normalized-0_steep.rds")
  saveRDS(p0, file = p0_file)
  p1_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-pca-normalized-1_steep.rds")
  saveRDS(p1, file = p1_file)
  p2_file <- paste0(data_dir,"/20201105_pass1a-metabolomics-",tissue,"-pca-normalized-2_steep.rds")
  saveRDS(p2, file = p2_file)
}

}
```


<!-- ## Session Info -->
<!-- ```{r Sesh} -->
<!-- session_info() -->
<!-- ``` -->